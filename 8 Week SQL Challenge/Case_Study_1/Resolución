 --¿Cuál es la cantidad total que gastó cada cliente en el restaurante?
 
SELECT SUM(e.price) as total_gastado, s.customer_id
FROM "menu" e 
JOIN sales s ON (e.product_id = s.product_id)
GROUP BY s.customer_id
ORDER BY s.customer_id

--¿Cuántos días ha visitado cada cliente el restaurante?

SELECT count(distinct(EXTRACT(DAY FROM order_date))) as cantidad_visitas, customer_id
FROM "sales" 
GROUP BY customer_id
ORDER BY customer_id

--¿Cuál fue el primer artículo del menú comprado por cada cliente?

SELECT e.product_name, s.customer_id
FROM "sales" s  JOIN menu e
ON (s.product_id = e.product_id)
WHERE order_date =  (select MIN(order_date) from "sales" )
GROUP BY  s.customer_id, e.product_name
ORDER BY s.customer_id

--¿Cuál es el artículo más comprado en el menú y cuántas veces lo compraron todos los clientes?
SELECT
e.product_name,
COUNT(*) AS total_comprado
FROM sales s
JOIN menu e 
ON s.product_id = e.product_id
GROUP BY  e.product_name
ORDER BY total_comprado desc
LIMIT 1

--¿Qué artículo fue el más popular para cada cliente?

WITH tmp as(
SELECT
e.product_name,
COUNT(*) AS total_comprado,
s.customer_id
FROM sales s
JOIN menu e 
ON s.product_id = e.product_id
GROUP BY  e.product_name,s.customer_id
),
top as (
SELECT product_name, customer_id, total_comprado,
DENSE_RANK() OVER( PARTITION BY customer_id ORDER BY total_comprado desc) as rank_product
FROM tmp
)
SELECT product_name, customer_id, total_comprado
FROM top
where rank_product = 1

