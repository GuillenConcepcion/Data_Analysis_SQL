--Para responder a las preguntas de negocio, realizaremos la siguientes sentencias:

--Agregamos una columna con un ID autoincremental  en la tabla customer_orders

ALTER TABLE pizza_runner.customer_orders
ADD COLUMN Cod_ID serial

--Creamos una vista a partir de la tabla pizza_recipes, con una fila para cada topping de cada categoría de pizza.  

CREATE VIEW pizza_runner.pizza_recipes_clean AS
SELECT pizza_id,  CAST(unnest(string_to_array(toppings, ',')) AS INT) AS topping_id
FROM pizza_runner.pizza_recipes 

--Creamos una segunda vista, con el numero de orden, la pizza pedida y si hubo extras o exclusiones 

CREATE VIEW pizza_runner.pizza_extras_exclusions AS
SELECT order_id, pizza_id,  CAST(unnest(string_to_array(exclusions, ',')) AS INT) AS exclusions_toppings,
CAST(unnest(string_to_array(extras, ',')) AS INT) AS extras_toppings
FROM pizza_runner.customer_orders

--1)¿Cuáles son los ingredientes estándar para cada pizza?

SELECT pizza_name, 
STRING_AGG(topping_name,  ', ') AS ingredientes
FROM pizza_runner.pizza_names n JOIN pizza_runner.pizza_recipes_clean r
ON (n.pizza_id = r.pizza_id) JOIN pizza_runner.pizza_toppings  t
ON  (r.topping_id = t.topping_id)
GROUP BY  pizza_name

--2)¿Cuál fue el extra más comúnmente añadido?

SELECT t.topping_name, COUNT(r.extras_toppings) AS extras 
FROM pizza_runner.pizza_extras_exclusions r
JOIN pizza_runner.pizza_toppings  t
ON  (r.extras_toppings = t.topping_id)
GROUP BY t.topping_name
ORDER BY extras DESC

--3)¿Cuál fue la exclusión más común?

SELECT t.topping_name, COUNT(r.exclusions_toppings) AS exclusions 
FROM pizza_runner.pizza_extras_exclusions r
JOIN pizza_runner.pizza_toppings  t
ON  (r.exclusions_toppings = t.topping_id)
GROUP BY t.topping_name
ORDER BY exclusions DESC

--4)Genere un artículo de pedido para cada registro en la tabla customers_orders en el formato de uno de los siguientes: 
--Meat Lovers / Meat Lovers - Exclude Beef / Meat Lovers - Extra Bacon / Meat Lovers - Exclude Cheese, Bacon - Extra Mushroom, Peppers








--5)Genere una lista de ingredientes separados por comas ordenados alfabéticamente para cada pedido de pizza de la tabla customer_orders y agregue 2x delante de cualquier ingrediente relevante Por ejemplo: "Amantes de la carne: 2xTocino, Carne de res, ... , Salami"

--6)¿Cuál es la cantidad total de cada ingrediente utilizado en todas las pizzas entregadas ordenadas por el más frecuente primero?
